<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Steven Universe</title>
    <script src="Scripts/jquery-3.3.1.js"></script>
    <script src="Scripts/bootstrap.js"></script>
    <link href="Content/bootstrap.css" rel="stylesheet" />

    <script>
        var episodes = [52, 26, 25, 25, 23];
        var seasons = 5;
        var onSeason = 0; 
        var onEpisode = 0;
        $(document).ready(function () {

            $("#su-season").on("change", seasonChanged);
            $("#su-episode").on("change", episodeChanged);
            for (var i = 1; i < seasons + 1; i++) {
                $("#su-season").append("<option>" + i + "</option>");
            }
            seasonChanged();
        });

        function seasonChanged() {
            var $suSeason = $("#su-season");
            var $suEpisode = $("#su-episode");
            onSeason = parseInt($suSeason.val());
            $suEpisode.empty();
            for (var i = 1; i < episodes[$suSeason.val() - 1] + 1; i++) {
                $suEpisode.append("<option>" + i + "</option>");
            }
        }

        function episodeChanged() {
            var $suSeason = $("#su-season");
            var $suEpisode = $("#su-episode");
            onEpisode = parseInt($suEpisode.val());
            loadEpisode(onSeason, onEpisode);
        }

        function loadEpisode(season, episode) {
            console.log("Steven Universe Season " + season + " episode " + episode);

            var apiQuery = "https://www.googleapis.com/customsearch/v1/?q=Steven+Universe+Season+" + season + "+Episode+" + episode + "&key=AIzaSyAu_7YlurM_lHXSK_M6vV4Cuy1nDYMUWdA&cx=004069985485939271697:zjk2yhbczj0";

            $.ajax({
                url: apiQuery,
                method: "GET",
                success: function (data) {
                    console.log(data.items);
                    var i = 0;
                    var found = false;
                    while ((i < data.items.length - 1) && !urlExists((data.items[i].formattedUrl.includes("https://") ? "" : "https://") + data.items[i].formattedUrl)) {
                        if (urlExists(data.items[i].formattedUrl.includes("https://") ? "" : "https://") + data.items[i].formattedUrl) break;
                        else i++;
                    }

                    var dataSplit = data.items[i].formattedUrl.split("/");
                    var videoUrl = dataSplit[dataSplit.length - 1];
                    dataSplit.pop();
                    dataSplit.pop();
                    dataSplit.push("embed/video");
                    dataSplit.push(videoUrl);
                    var embed = dataSplit.join("/");
                    $("#backup-link").attr("href", "https://" + data.items[i].htmlFormattedUrl.split("https://")[1]);
                    $("#iframe-area").empty();
                    $("#iframe-area").append("<iframe frameborder=\"0\" width=\"960\" height=\"540\" src=\"http://" + embed + "\" allowfullscreen allow=\"autoplay\"></iframe>");
                }
            });

            var $btnNext = $("#btn-next");
            var $btnPrevious = $("#btn-previous");

            $btnNext.text("Episode " + (episode + 1));
            $btnPrevious.text("Episode " + (episode - 1));
            $btnPrevious.attr("onclick", "loadEpisode(" + season + "," + (episode - 1) + ")");
            $btnNext.attr("onclick", "loadEpisode(" + season + "," + (episode + 1) + ")");
        }

        function urlExists(url) {
            try {
                var request;
                if (window.XMLHttpRequest)
                    request = new XMLHttpRequest();
                else
                    request = new ActiveXObject("Microsoft.XMLHTTP");
                request.open('GET', url, false);
                request.send(); // there will be a 'pause' here until the response to come.
                // the object request will be actually modified
                if (request.status === 404) {
                    return false;
                } else {
                    return true;
                }
            } catch (err) {
                return false;
            }
            return false;
        }

    </script>
</head>
<body>
    <div class="container">
        <div class="row">
            <label for="su-season">Season:</label>
            <select id="su-season">

            </select>
            <label for="su-episode">Episode:</label>
            <select id="su-episode">

            </select>
        </div>
        <div class="row">
            <div class="col-1">
                <button class="btn btn-primary" id="btn-previous">
                    Episode X 
                </button>
            </div>
            <div class="col-10" id="iframe-area">

            </div>
            <div class="col-1">
                <button class="btn btn-primary" id="btn-next">
                    Episode Y
                </button>
            </div>
        </div>
        <div class="row">
            <div class="text-center">If the video did not load, <a id="backup-link" href="" target="_blank">click this link</a></div>
        </div>
    </div>

   
</body>
</html>