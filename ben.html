<!DOCTYPE html>
<html>
<head>
    <title>Ben Test</title>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script>
        var barchart = null;
        var piechart = null;
        var timer;
        var cached = {};
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
            "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
        ];
        var data = {};
        var apiData = {};
        $(function () {
            pollAPI();
            timer = setInterval(pollAPI, 1000);
        });

        function arraysEqual(a, b) {
            if (a === b) return true;
            if (a == null || b == null) return false;
            if (a.length != b.length) return false;
            for (var i = 0; i < a.length; ++i) {
                if (a[i] !== b[i]) return false;
            }
            return true;
        }

        function pollAPI() {
            apiData = $.get("http://idanscott.co.uk/benproxy/explorelearning/closed/?authorization=SVQgQVBJOjM0M3Z5LXZ5anQzLWMzZXprLXNxc3dhLWVxeWhs", function (JSON) {
                var data = {
                    labels: Object.keys(JSON), 
                    data: Object.values(JSON),
                }
                
                if (!arraysEqual(data.labels, cached.labels) && !arraysEqual(data.data, cached.data)) {
                    barchart = buildChart(data, barchart, "bar", "barchart");
                    piechart = buildChart(data, piechart, "pie", "piechart");
                }
                cached = data;
            });
        }

        function buildChart(data, chartObj, type, container) {
            if (chartObj != null) chartObj.destroy();
            var ctx = $("#" + container);

            var chartObj = new Chart(ctx, {
                type: type,
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: "Tickets closed by month (" + type + "chart)",
                        data: data.data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255,99,132,1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    title: {
                            display: true,
                            text: "Tickets closed by month (" + type + "chart)"
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                beginAtZero: true
                            }
                        }]
                    }
                }
            });
            return chartObj;
        }
    </script>
</head>   
    <body>
        <div class="container">
            <div class="row">
                <div class="col-md-6" id="barchart-container">
                    <canvas id="barchart" width="400" height="400"></canvas>
                </div>
                <div class="col-md-6" id="piechart-container">
                    <canvas id="piechart" width="400" height="400"></canvas>
                </div>
            </div>
        </div>
    </body>
</html>
